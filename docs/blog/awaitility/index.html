<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Awaitility | Boris van Katwijk</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Writing tests on asynchronous code can be a challenge. Given an asynchronous process to test, we may try to use custom code to wait for the process to finish or reach a certain state. This may cause us to end up with tests that are flaky, slow, or hard to understand. It is not uncommon for legacy projects to have these setups, and perhaps they can be improved a little.">
    <meta name="generator" content="Hugo 0.142.0">
    
    
    
      <meta name="robots" content="index, follow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.d05fb5f317fcf33b3a52936399bdf6f47dc776516e1692e412ec7d76f4a5faa2.css" >



    

    
      

    

    

    
      <link rel="canonical" href="https://bvkatwijk.github.io/blog/awaitility/">
    

    <meta property="og:url" content="https://bvkatwijk.github.io/blog/awaitility/">
  <meta property="og:site_name" content="Boris van Katwijk">
  <meta property="og:title" content="Awaitility">
  <meta property="og:description" content="Writing tests on asynchronous code can be a challenge. Given an asynchronous process to test, we may try to use custom code to wait for the process to finish or reach a certain state. This may cause us to end up with tests that are flaky, slow, or hard to understand. It is not uncommon for legacy projects to have these setups, and perhaps they can be improved a little.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2024-10-07T10:01:38+00:00">
    <meta property="article:modified_time" content="2024-10-07T19:58:57+00:00">
    <meta property="article:tag" content="Devoxx">
    <meta property="article:tag" content="Java">
    <meta property="article:tag" content="Test">
    <meta property="article:tag" content="Dx">
    <meta property="article:tag" content="Api">
    <meta property="article:tag" content="Short">

  <meta itemprop="name" content="Awaitility">
  <meta itemprop="description" content="Writing tests on asynchronous code can be a challenge. Given an asynchronous process to test, we may try to use custom code to wait for the process to finish or reach a certain state. This may cause us to end up with tests that are flaky, slow, or hard to understand. It is not uncommon for legacy projects to have these setups, and perhaps they can be improved a little.">
  <meta itemprop="datePublished" content="2024-10-07T10:01:38+00:00">
  <meta itemprop="dateModified" content="2024-10-07T19:58:57+00:00">
  <meta itemprop="wordCount" content="254">
  <meta itemprop="keywords" content="Devoxx,Java,Test,Dx,Api,Short,Spring">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Awaitility">
  <meta name="twitter:description" content="Writing tests on asynchronous code can be a challenge. Given an asynchronous process to test, we may try to use custom code to wait for the process to finish or reach a certain state. This may cause us to end up with tests that are flaky, slow, or hard to understand. It is not uncommon for legacy projects to have these setups, and perhaps they can be improved a little.">

      
    
	
  </head><body class="ma0 avenir bg-near-white production">

    
   
  

  
  
  
  <header class="cover bg-center" style="background-image: url('https://bvkatwijk.github.io/images/awaitility.png');">
    <div class="bg-black-60">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Boris van Katwijk
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/pages/contact/" title="Contact page">
              Contact
            </a>
          </li>
          
        </ul>
      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

      <div class="tc-l pv6 ph3 ph4-ns">
        
          <div class="f2 f1-l fw2 white-90 mb0 lh-title">Awaitility</div>
          
        
      </div>
    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Blogs
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Awaitility</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2024-10-07T10:01:38Z">October 7, 2024</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>Writing tests on asynchronous code can be a challenge. Given an asynchronous process to test, we may try to use custom code to wait for the process to finish or reach a certain state. This may cause us to end up with tests that are flaky, slow, or hard to understand. It is not uncommon for legacy projects to have these setups, and perhaps they can be improved a little.</p>
<p><a href="http://www.awaitility.org/">Awaitility</a> provides a nice DSL to help us out. We can easily specify the condition we wait for and the maximum amount of time to wait.</p>
<p>As an example, let us use an <code>AtomicReference</code> as a thread-safe value container for a result String:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> result <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicReference<span style="color:#f92672">&lt;&gt;</span>(<span style="color:#e6db74">&#34;&#34;</span>);
</span></span></code></pre></div><p>We use an asynchronous process that waits an unknown amount of seconds before setting a result value:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">new</span> Thread(() <span style="color:#f92672">-&gt;</span> {  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> { Thread.<span style="color:#a6e22e">sleep</span>(A_FEW_SECONDS); } <span style="color:#66d9ef">catch</span> (Exception e) {}  
</span></span><span style="display:flex;"><span>    result.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#34;done!&#34;</span>);  
</span></span><span style="display:flex;"><span>}).<span style="color:#a6e22e">start</span>();
</span></span></code></pre></div><p>We would like to wait until the result is ready. Let&rsquo;s choose five seconds as the maximum amount of time to wait. Using Awaitility&rsquo;s declarative API, it&rsquo;s easy to specify how long to wait and which condition to verify:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Awaitility.<span style="color:#a6e22e">await</span>()  
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">atMost</span>(Duration.<span style="color:#a6e22e">ofSeconds</span>(5))  
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">until</span>(() <span style="color:#f92672">-&gt;</span> result.<span style="color:#a6e22e">get</span>().<span style="color:#a6e22e">equals</span>(<span style="color:#e6db74">&#34;done!&#34;</span>));
</span></span></code></pre></div><p>Internally, Awaitility will repeatedly check the condition until success or until timeout. It has a rich fluent DSL to add configuration. Awaitility is <a href="https://github.com/spring-projects/spring-boot/issues/37195">included in Spring Boot Starter Test</a> by default.</p>
<p><a href="https://github.com/Kehrlann">Daniel Garnier-Moiroux</a> showed this tool in action in his presentation <a href="https://devoxx.be/talk/spring-boot-testing-zero-to-hero/">Spring Boot testing: Zero to Hero</a> at <a href="https://devoxx.be/">Devoxx Belgium 2024</a>.</p>
<p>Happy testing!</p>
<h3 id="links">Links</h3>
<ul>
<li><a href="http://www.awaitility.org/">Awaitility Home Page</a></li>
<li><a href="https://mvnrepository.com/artifact/org.awaitility/awaitility">Awaitility on Maven Repository</a></li>
</ul>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/devoxx/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Devoxx</a>
   </li>
  
   <li class="list di">
     <a href="/tags/java/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Java</a>
   </li>
  
   <li class="list di">
     <a href="/tags/test/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Test</a>
   </li>
  
   <li class="list di">
     <a href="/tags/dx/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Dx</a>
   </li>
  
   <li class="list di">
     <a href="/tags/api/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Api</a>
   </li>
  
   <li class="list di">
     <a href="/tags/short/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Short</a>
   </li>
  
   <li class="list di">
     <a href="/tags/spring/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Spring</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">

        <div id="comments">
          
            <link rel="stylesheet" href="/css/comments.css" />
<script>
    var id = "11";
  
    if (id)
    {
      let url = "https://github.com/bvkatwijk/bvkatwijk.github.io/issues/".concat(id);
      let api_url = "https://api.github.com/repos/bvkatwijk/bvkatwijk.github.io/issues/".concat(id, "/comments");
      
      var commentsDiv = document.getElementById("comments");
  
      let xhr = new XMLHttpRequest();
      xhr.responseType = "json";
      xhr.open("GET", api_url);
      xhr.setRequestHeader("Accept", "application/vnd.github.v3.html+json");
      xhr.send();
  
      xhr.onload = function()
      {
        if (xhr.status != 200)
        {
          let errorText = document.createElement("p");
          errorText.innerHTML = "<i>Comments for this post yet are not opened yet (or you have GitHub scripts disabled).</i>";
          commentsDiv.appendChild(errorText);
        }
        else
        {
          let comments = xhr.response;
  
          let mainHeader = document.createElement("h2");
          mainHeader.innerHTML = "Comments: ".concat(comments.length);
          commentsDiv.appendChild(mainHeader);
  
          let issueLink = document.createElement("p");
          issueLink.innerHTML = "<i>You can leave a comment using this <a href='".concat(url, "'>GitHub issue</a>.</i>");
          commentsDiv.appendChild(issueLink);
          
          comments.forEach(function(comment)
          {
              let commentContent = document.createElement("div");
              commentContent.setAttribute('class', 'gh-comment')
              commentContent.innerHTML = "".concat(
                  "<div class='gh-header'>",
                    "<img src='", comment.user.avatar_url, "' />",
                    "<div style='margin:auto 0;'>",
                      "<b><a class='gh-username' href='", comment.user.html_url, "'>", comment.user.login, "</a></b>",
                      " commented at <em>", new Date(comment.created_at), "</em>",
                    "</div>",
                  "</div>",
                  "<div class='gh-body'>",
                    comment.body_html,
                  "</div>"
              );
              commentsDiv.appendChild(commentContent);
          });
        }
      };
  
      xhr.onerror = function()
      {
        let errorText = document.createElement("p");
        errorText.innerHTML = "<i>Some error loading comments.</i>";
        commentsDiv.appendChild(errorText);
      };
    }
  </script>
          
        </div>
      
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/java---error-return-types/">Java - Error Return Types</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/java---unique-enum-field-values/">Java - Unique Enum Field values</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/dev---hugo/">Hugo</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://bvkatwijk.github.io/" >
    &copy;  Boris van Katwijk 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
